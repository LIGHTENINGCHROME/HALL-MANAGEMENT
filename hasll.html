<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Halls</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Defer AlpineJS script to ensure it runs after the DOM is parsed -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        /* Custom styles for Montserrat font and scrollable dropdowns */
        body {
            font-family: 'Montserrat', sans-serif;
            background-image: linear-gradient(to right, #14555F, #0B1940);
            background-attachment: fixed;
        }
        
        /* Custom toggle switch */
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #2196F3; }
        input:focus + .toggle-slider { box-shadow: 0 0 1px #2196F3; }
        input:checked + .toggle-slider:before { transform: translateX(26px); }

        [x-cloak] { display: none !important; }

        .filter-button {
            transition: color 0.2s ease-in-out;
        }
        .filter-button.active {
            color: #3B82F6; /* blue-500 */
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-[rgba(0,0,0,0.63)] text-white p-4 shadow-md flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <div class="h-[60px] rounded-full overflow-hidden">
                <img src="https://placehold.co/60x60/14555F/FFFFFF?text=PU" alt="Logo" class="w-full h-full object-contain" onerror="this.src='https://placehold.co/60x60/14555F/FFFFFF?text=PU'; this.onerror=null;">
            </div>
            <h1 class="text-xl font-semibold">PONDICHERRY UNIVERSITY</h1>
        </div>
        <div class="flex items-center space-x-4">
            <span class="text-lg font-medium">ADMIN</span>
            <span class="text-lg">|</span>
            <a href="#" class="text-lg font-medium hover:underline flex items-center space-x-1">
                <span>LOGOUT</span>
                <i class="fas fa-sign-out-alt"></i>
            </a>
        </div>
    </header>

    <!-- Navigation Bar -->
    <nav class="bg-[rgba(255,255,255,0.11)] text-white shadow-lg py-1">
        <div class="container mx-auto flex justify-center space-x-8 lg:space-x-12 relative">
            <div class="relative group"><a href="#" class="flex items-center space-x-2 text-lg font-medium hover:text-blue-300 transition-colors duration-200 py-2 px-3 rounded-md"><span>DASHBOARD</span></a></div>
            <div class="relative group" x-data="{ open: false }" @click.away="open = false">
                <button @click="open = !open" class="flex items-center space-x-2 text-lg font-medium hover:text-blue-300 transition-colors duration-200 py-2 px-3 rounded-md focus:outline-none"><span>HALL DETAILS</span><i class="fas fa-chevron-down text-sm" :class="{ 'rotate-180': open }"></i></button>
                <div x-show="open" x-transition class="absolute left-1/2 -translate-x-1/2 mt-2 w-48 bg-gray-700 rounded-md shadow-lg py-1 z-10"><a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 hover:text-white">Add Hall</a><a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 hover:text-white">Manage Halls</a></div>
            </div>
            <div class="relative group" x-data="{ open: false }" @click.away="open = false">
                <button @click="open = !open" class="flex items-center space-x-2 text-lg font-medium hover:text-blue-300 transition-colors duration-200 py-2 px-3 rounded-md focus:outline-none"><span>SCHOOL/DEPARTMENT</span><i class="fas fa-chevron-down text-sm" :class="{ 'rotate-180': open }"></i></button>
                <div x-show="open" x-transition class="absolute left-1/2 -translate-x-1/2 mt-2 w-56 bg-gray-700 rounded-md shadow-lg py-1 z-10"><a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 hover:text-white">Add School/Department</a><a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 hover:text-white">Manage School/Department</a></div>
            </div>
            <div class="relative group" x-data="{ open: false }" @click.away="open = false">
                <button @click="open = !open" class="flex items-center space-x-2 text-lg font-medium hover:text-blue-300 transition-colors duration-200 py-2 px-3 rounded-md focus:outline-none"><span>EMPLOYEE DETAILS</span><i class="fas fa-chevron-down text-sm" :class="{ 'rotate-180': open }"></i></button>
                <div x-show="open" x-transition class="absolute left-1/2 -translate-x-1/2 mt-2 w-48 bg-gray-700 rounded-md shadow-lg py-1 z-10"><a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 hover:text-white">Add Employee</a><a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 hover:text-white">View Employees</a></div>
            </div>
        </div>
    </nav>

    <main class="flex-grow p-6">
        <div class="container mx-auto bg-[rgba(0,0,0,0.15)] p-8 rounded-lg shadow-xl" x-data="manageHalls">
            <div class="flex justify-between items-center mb-6">
                 <h2 class="text-3xl font-bold text-white">Manage Halls</h2>
                <div class="flex items-center space-x-4">
                    <button @click="resetFilters" 
                            :class="isAnyFilterActive ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-500 hover:bg-gray-600'"
                            class="text-white font-bold py-2 px-4 rounded-md shadow-lg flex items-center space-x-2 transition-colors duration-300">
                        <i class="fas fa-undo"></i><span>Reset Filters</span>
                    </button>
                    <div class="flex items-center space-x-2 text-white">
                        <span>Multiple Selection:</span>
                        <label class="toggle-switch"><input type="checkbox" x-model="multipleSelectionEnabled"><span class="toggle-slider"></span></label>
                    </div>
                </div>
            </div>

            <!-- MODALS -->
            <div x-show="modals.hallDetails" @click.away="modals.hallDetails = false" x-transition class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md relative">
                    <button @click="modals.hallDetails = false" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                    <h3 class="text-xl font-bold mb-4 border-b pb-2 text-blue-600">Filter Hall Details</h3>
                    <div class="space-y-4">
                        <div><label class="font-semibold">Hall Type:</label><div class="flex flex-wrap gap-4 mt-2"><label><input type="radio" x-model="filters.type" value="SEMINAR"> Seminar</label><label><input type="radio" x-model="filters.type" value="AUDITORIUM"> Auditorium</label><label><input type="radio" x-model="filters.type" value="LECTURE"> Lecture</label><label><input type="radio" x-model="filters.type" value="CONFERENCE"> Conference</label></div></div>
                        <div><label class="font-semibold">Hall Name:</label><input type="text" x-model.debounce.300ms="filters.name" class="w-full p-2 border rounded mt-1"></div>
                        <div><label class="font-semibold">Capacity:</label><div class="flex flex-wrap gap-4 mt-2"><label><input type="radio" x-model="filters.capacity" value="<50"> &lt; 50</label><label><input type="radio" x-model="filters.capacity" value="50-100"> 50-100</label><label><input type="radio" x-model="filters.capacity" value=">100"> &gt; 100</label></div></div>
                        <div><label class="font-semibold">Floor:</label><div class="flex flex-wrap gap-4 mt-2"><label><input type="radio" x-model="filters.floor" value="GROUND"> Ground</label><label><input type="radio" x-model="filters.floor" value="FIRST"> First</label><label><input type="radio" x-model="filters.floor" value="SECOND"> Second</label></div></div>
                        <div><label class="font-semibold">Zone:</label><div class="flex flex-wrap gap-4 mt-2"><label><input type="radio" x-model="filters.zone" value="NORTH"> North</label><label><input type="radio" x-model="filters.zone" value="SOUTH"> South</label><label><input type="radio" x-model="filters.zone" value="EAST"> East</label><label><input type="radio" x-model="filters.zone" value="WEST"> West</label></div></div>
                    </div>
                    <button @click="modals.hallDetails = false" class="w-full mt-6 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Apply Filter</button>
                </div>
            </div>
            <div x-show="modals.belongsTo" @click.away="modals.belongsTo = false" x-transition class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                 <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md relative">
                    <button @click="modals.belongsTo = false" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                    <h3 class="text-xl font-bold mb-4 border-b pb-2 text-blue-600">Filter School/Department/Section</h3>
                    <div class="space-y-4">
                        <div><label class="font-semibold">Type:</label><div class="flex flex-wrap gap-4 mt-2"><label><input type="radio" x-model="filters.ownerType" value="department"> Department</label><label><input type="radio" x-model="filters.ownerType" value="school"> School</label><label><input type="radio" x-model="filters.ownerType" value="administration"> Administration</label></div></div>
                        <div x-show="filters.ownerType === 'school' || filters.ownerType === 'department'"><label class="font-semibold">School Name:</label><select x-model="filters.schoolId" class="w-full p-2 border rounded mt-1"><option value="">All Schools</option><template x-for="school in schoolOptions" :key="school.value"><option :value="school.value" x-text="school.label"></option></template></select></div>
                        <div x-show="filters.ownerType === 'department'"><label class="font-semibold">Department:</label><select x-model="filters.departmentId" class="w-full p-2 border rounded mt-1"><option value="">All Departments</option><template x-for="dept in departmentOptions" :key="dept.value"><option :value="dept.value" x-text="dept.label"></option></template></select></div>
                    </div>
                    <button @click="modals.belongsTo = false" class="w-full mt-6 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Apply Filter</button>
                </div>
            </div>
            <div x-show="modals.features" @click.away="modals.features = false" x-transition class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                 <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md relative">
                    <button @click="modals.features = false" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                    <h3 class="text-xl font-bold mb-4 border-b pb-2 text-blue-600">Filter Features</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <template x-for="feature in allFeatures" :key="feature"><label class="flex items-center"><input type="checkbox" :value="feature" x-model="filters.features" class="mr-2"><span x-text="feature"></span></label></template>
                    </div>
                    <button @click="modals.features = false" class="w-full mt-6 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Apply Filter</button>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md">
                <!-- Header Row -->
                <div class="hidden md:flex bg-gray-50 rounded-t-lg px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider items-center">
                    <div class="w-1/12">Select</div>
                    <div class="w-1/12">Date</div>
                    <div class="w-2/12 flex items-center">Hall Details <button @click="modals.hallDetails = true" class="ml-2 text-gray-400 hover:text-blue-500 filter-button" :class="{'active': isFilterActive('hallDetails')}"><i class="fas fa-filter"></i></button></div>
                    <div class="w-2/12 flex items-center">Belongs To <button @click="modals.belongsTo = true" class="ml-2 text-gray-400 hover:text-blue-500 filter-button" :class="{'active': isFilterActive('belongsTo')}"><i class="fas fa-filter"></i></button></div>
                    <div class="w-4/12 flex items-center">Features <button @click="modals.features = true" class="ml-2 text-gray-400 hover:text-blue-500 filter-button" :class="{'active': isFilterActive('features')}"><i class="fas fa-filter"></i></button></div>
                    <div class="w-2/12">Status</div>
                </div>

                <!-- Loading/Error State -->
                <div x-show="isLoading || errorMessage" class="p-4 text-center"><span x-show="isLoading"><i class="fas fa-spinner fa-spin mr-2"></i>Loading Hall Data...</span><span x-show="errorMessage" class="text-red-600" x-text="errorMessage"></span></div>

                <!-- Hall Cards -->
                <div x-show="!isLoading && !errorMessage" x-cloak class="divide-y divide-gray-200">
                    <template x-for="hall in filteredHalls" :key="hall.unique_id">
                        <div class="flex flex-col md:flex-row items-start md:items-center p-6 hover:bg-gray-50">
                            <div class="w-full md:w-1/12 mb-4 md:mb-0 flex items-center"><input type="checkbox" class="focus:ring-blue-500 h-5 w-5 text-blue-600 border-gray-300 rounded" :checked="selectedItems.includes(hall.unique_id)" @change="toggleItemSelection(hall.unique_id)" :disabled="!multipleSelectionEnabled && selectedItems.length > 0 && !selectedItems.includes(hall.unique_id)"></div>
                            <div class="w-full md:w-1/12 mb-4 md:mb-0 text-sm text-gray-700" x-text="hall.date"></div>
                            <div class="w-full md:w-2/12 mb-4 md:mb-0"><a href="#" class="text-blue-600 hover:underline font-semibold" x-text="hall.type"></a><p class="text-gray-900 font-medium" x-text="hall.name"></p><p class="text-sm text-gray-500" x-text="hall.capacity + ' Capacity'"></p><p class="text-sm text-gray-500" x-text="hall.floor"></p><p class="text-sm text-gray-500" x-text="hall.zone"></p></div>
                            <div class="w-full md:w-2/12 mb-4 md:mb-0"><p class="text-gray-900 font-medium" x-text="hall.primaryOwner"></p><p class="text-sm text-gray-500" x-text="hall.secondaryOwner"></p></div>
                            <div class="w-full md:w-4/12 mb-4 md:mb-0 text-sm text-gray-600" x-text="hall.features.join(', ')"></div>
                            <div class="w-full md:w-2/12"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" :class="hall.status === 'Available' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" x-text="hall.status"></span></div>
                        </div>
                    </template>
                    <template x-if="filteredHalls.length === 0 && !isLoading"><div class="text-center p-4 text-gray-500">No halls match the current filters.</div></template>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white text-center p-4 mt-auto">
        <p>&copy; 2025 Pondicherry University. All rights reserved.</p>
    </footer>

    <script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('manageHalls', () => ({
            halls: [],
            schoolOptions: [],
            departmentOptions: [],
            allFeatures: ['AC', 'Projector', 'WIFI', 'Podium', 'Computer', 'Lift', 'Ramp', 'Audio', 'White Board', 'Black Board', 'Smart Board'],
            selectedItems: [],
            multipleSelectionEnabled: false,
            isLoading: true,
            errorMessage: '',
            modals: { hallDetails: false, belongsTo: false, features: false },
            filters: {
                name: '', type: '', capacity: '', floor: '', zone: '',
                ownerType: '', schoolId: '', departmentId: '',
                features: []
            },

            init() { this.loadData(); this.$watch('multipleSelectionEnabled', (value) => { if (!value) this.selectedItems = []; }); },

            get filteredHalls() {
                return this.halls.filter(hall => {
                    const f = this.filters;
                    // Hall Details Filters
                    if (f.name && !hall.name.toLowerCase().includes(f.name.toLowerCase())) return false;
                    if (f.type && hall.type.toUpperCase() !== f.type) return false;
                    if (f.floor && hall.floor.toUpperCase().split(' ')[0] !== f.floor) return false;
                    if (f.zone && hall.zone.toUpperCase().split(' ')[0] !== f.zone) return false;
                    if (f.capacity) {
                        if (f.capacity === '<50' && hall.capacity >= 50) return false;
                        if (f.capacity === '50-100' && (hall.capacity < 50 || hall.capacity > 100)) return false;
                        if (f.capacity === '>100' && hall.capacity <= 100) return false;
                    }
                    // Belongs To Filters
                    if (f.ownerType === 'administration' && hall.primaryOwner !== 'Administration') return false;
                    if (f.ownerType === 'school' && !hall.school_id) return false;
                    if (f.ownerType === 'department' && !hall.department_id) return false;
                    if (f.schoolId && hall.school_id !== f.schoolId) return false;
                    if (f.departmentId && hall.department_id !== f.departmentId) return false;
                    // Features Filter
                    if (f.features.length > 0 && !f.features.every(feature => hall.features.includes(feature))) return false;
                    
                    return true;
                });
            },

            isFilterActive(filterGroup) {
                if (filterGroup === 'hallDetails') return this.filters.name || this.filters.type || this.filters.capacity || this.filters.floor || this.filters.zone;
                if (filterGroup === 'belongsTo') return this.filters.ownerType || this.filters.schoolId || this.filters.departmentId;
                if (filterGroup === 'features') return this.filters.features.length > 0;
                return false;
            },
            
            get isAnyFilterActive() {
                return this.isFilterActive('hallDetails') || this.isFilterActive('belongsTo') || this.isFilterActive('features');
            },

            resetFilters() {
                this.filters = { name: '', type: '', capacity: '', floor: '', zone: '', ownerType: '', schoolId: '', departmentId: '', features: [] };
            },
            
            async loadData() {
                this.isLoading = true;
                this.errorMessage = '';
                try {
                    const hallResponse = await fetch('https://hall-management.nirmaljyotib.workers.dev/api/hall/all-hall');
                    if (!hallResponse.ok) throw new Error(`Failed to fetch halls: ${hallResponse.statusText}`);
                    const hallData = await hallResponse.json();
                    const hallList = (Array.isArray(hallData) ? hallData : hallData.halls || hallData.data || []).filter(h => h && h.unique_id && h.name);

                    this.halls = hallList.map(hall => ({
                        ...hall,
                        primaryOwner: 'Loading...',
                        secondaryOwner: '',
                        status: hall.available ? 'Available' : 'Unavailable',
                        date: hall.created_at ? new Date(hall.created_at).toISOString().split('T')[0] : 'N/A',
                        floor: hall.floor ? hall.floor.charAt(0).toUpperCase() + hall.floor.slice(1).toLowerCase() + ' Floor' : 'N/A',
                        zone: hall.zone ? hall.zone.charAt(0).toUpperCase() + hall.zone.slice(1).toLowerCase() + ' Zone' : 'N/A',
                        features: Array.isArray(hall.features) ? hall.features.map(f => f.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())) : []
                    }));
                    
                    this.isLoading = false;

                    const [schoolResponse, departmentResponse] = await Promise.all([
                        fetch('https://hall-management.nirmaljyotib.workers.dev/api/school/all-schools'),
                        fetch('https://hall-management.nirmaljyotib.workers.dev/api/department/all-department')
                    ]);

                    if (!schoolResponse.ok || !departmentResponse.ok) {
                        this.halls.forEach(hall => { hall.primaryOwner = 'N/A'; });
                        throw new Error('Failed to fetch owner details');
                    }

                    const schoolData = await schoolResponse.json();
                    const departmentData = await departmentResponse.json();
                    
                    const schoolList = (Array.isArray(schoolData) ? schoolData : schoolData.schools || schoolData.data || []).filter(s => s && s.unique_id && s.school_name);
                    const departmentList = (Array.isArray(departmentData) ? departmentData : departmentData.departments || departmentData.data || []).filter(d => d && d.unique_id && d.department_name);

                    const schoolMap = new Map(schoolList.map(s => [s.unique_id, s.school_name]));
                    const departmentMap = new Map(departmentList.map(d => [d.unique_id, d.department_name]));
                    
                    this.schoolOptions = schoolList.map(s => ({ value: s.unique_id, label: s.school_name }));
                    this.departmentOptions = departmentList.map(d => ({ value: d.unique_id, label: d.department_name }));

                    this.halls.forEach(hall => {
                        let primaryOwner = 'Administration';
                        let secondaryOwner = hall.section || '';

                        if (hall.school_id && schoolMap.has(hall.school_id)) {
                            primaryOwner = schoolMap.get(hall.school_id);
                            secondaryOwner = '';
                        }
                        if (hall.department_id && departmentMap.has(hall.department_id)) {
                            secondaryOwner = departmentMap.get(hall.department_id);
                        }
                        
                        hall.primaryOwner = primaryOwner;
                        hall.secondaryOwner = secondaryOwner;
                    });

                } catch (error) {
                    this.errorMessage = `An error occurred: ${error.message}. Please try again later.`;
                    console.error('Error loading data:', error);
                    this.isLoading = false;
                }
            },

            toggleItemSelection(itemId) {
                if (this.multipleSelectionEnabled) {
                    const index = this.selectedItems.indexOf(itemId);
                    if (index === -1) {
                        this.selectedItems.push(itemId);
                    } else {
                        this.selectedItems.splice(index, 1);
                    }
                } else {
                    this.selectedItems = this.selectedItems.includes(itemId) ? [] : [itemId];
                }
            }
        }));
    });
    </script>
</body>
</html>
